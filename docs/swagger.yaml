openapi: 3.0.0
info:
  title: ZRS Cars Trading CRM API
  description: |
    Comprehensive CRM API for ZRS Cars Trading managing purchases, inventory, sales, investors, and customer service.
    
    ## Authentication
    Most endpoints require JWT authentication. Include the token in the Authorization header:
    ```
    Authorization: Bearer <your_jwt_token>
    ```
    
    ## Roles
    - **Admin**: Full system access
    - **Manager**: Lead management, PO creation, inventory operations
    - **Investor**: Read-only access to portfolio
    
  version: 1.0.0
  contact:
    email: dev@zrscarstrading.com
  license:
    name: Proprietary
    
servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://api.zrscarstrading.com/api
    description: Production server

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      
  schemas:
    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "Error message"
        errors:
          type: array
          items:
            type: string
            
    User:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [admin, manager, investor]
        status:
          type: string
          enum: [invited, active, inactive]
          
    Lead:
      type: object
      properties:
        _id:
          type: string
        leadId:
          type: string
          example: "PL0001"
        type:
          type: string
          enum: [purchase, sales]
        source:
          type: string
          enum: [phone, email, walk-in, website, referral, social-media, other]
        status:
          type: string
          enum: [new, contacted, qualified, negotiation, under_review, approved, converted, lost, cancelled]
        contactInfo:
          type: object
          properties:
            name:
              type: string
            phone:
              type: string
            email:
              type: string
        vehicleInfo:
          type: object
          properties:
            make:
              type: string
            model:
              type: string
            year:
              type: integer
            askingPrice:
              type: number
        createdAt:
          type: string
          format: date-time
          
    Vehicle:
      type: object
      properties:
        _id:
          type: string
        vehicleId:
          type: string
          example: "V0001"
        make:
          type: string
        model:
          type: string
        year:
          type: integer
        mileage:
          type: number
        status:
          type: string
          enum: [lead, negotiation, under_review, approved, purchased, in_inventory, ready_for_sale, test_drive, sold, consignment_active]
        purchasePrice:
          type: number
        sellingPrice:
          type: number
        investorAllocation:
          type: array
          items:
            type: object
            properties:
              investorId:
                type: string
              amount:
                type: number
              percentage:
                type: number
                
    PurchaseOrder:
      type: object
      properties:
        _id:
          type: string
        poId:
          type: string
          example: "PO0001"
        vehicleId:
          type: string
        amount:
          type: number
        investorAllocations:
          type: array
          items:
            type: object
            properties:
              investorId:
                type: string
              amount:
                type: number
              percentage:
                type: number
        docuSignEnvelopeId:
          type: string
        docuSignStatus:
          type: string
          enum: [created, sent, delivered, signed, completed, declined, voided]
        approvedBy:
          type: array
          items:
            type: object
            properties:
              adminId:
                type: string
              approvedAt:
                type: string
                format: date-time
              comments:
                type: string
        status:
          type: string
          enum: [draft, pending_approval, approved, pending_signature, signed, completed, rejected, cancelled]
        createdAt:
          type: string
          format: date-time
          
    Sale:
      type: object
      properties:
        _id:
          type: string
        saleId:
          type: string
          example: "S0001"
        vehicleId:
          type: string
        customerName:
          type: string
        sellingPrice:
          type: number
        purchasePrice:
          type: number
        profit:
          type: number
        profitPercentage:
          type: number
        investorBreakdown:
          type: array
          items:
            type: object
            properties:
              investorId:
                type: string
              investmentAmount:
                type: number
              profitAmount:
                type: number
              totalPayout:
                type: number
        approvedBy:
          type: array
          items:
            type: object
        status:
          type: string
          enum: [draft, pending_approval, approved, invoice_generated, completed, rejected]

tags:
  - name: Authentication
    description: User authentication and authorization
  - name: Admin
    description: Admin operations (Admin only)
  - name: Purchases
    description: Purchase lead and PO management
  - name: Sales
    description: Sales lead and closing operations
  - name: Investors
    description: Investor management and SOA
  - name: CSA
    description: Customer service and ticketing
  - name: Exports
    description: Excel export operations
  - name: Integrations
    description: Third-party integrations
  - name: Webhooks
    description: Webhook callbacks

paths:
  /auth/admin/login:
    post:
      tags: [Authentication]
      summary: Admin login with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: "admin@zrscarstrading.com"
                password:
                  type: string
                  example: "Admin@123"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  token:
                    type: string
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
                
  /auth/request-otp:
    post:
      tags: [Authentication]
      summary: Request OTP for Manager/Investor login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
                  example: "manager@zrscarstrading.com"
      responses:
        '200':
          description: OTP sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                    example: "OTP sent to your email"
        '404':
          description: User not found
          
  /auth/verify-otp:
    post:
      tags: [Authentication]
      summary: Verify OTP and login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, otp]
              properties:
                email:
                  type: string
                  format: email
                otp:
                  type: string
                  example: "123456"
      responses:
        '200':
          description: OTP verified, login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  token:
                    type: string
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Invalid OTP
          
  /auth/invite:
    post:
      tags: [Authentication]
      summary: Admin invites Manager or Investor
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, role]
              properties:
                email:
                  type: string
                  format: email
                role:
                  type: string
                  enum: [manager, investor]
                name:
                  type: string
                creditLimit:
                  type: number
                  description: Required for investor role
      responses:
        '201':
          description: Invitation sent
        '403':
          description: Admin access required
          
  /auth/user:
    get:
      tags: [Authentication]
      summary: Get current logged-in user
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  user:
                    $ref: '#/components/schemas/User'
                    
  /v1/admin/dashboard:
    get:
      tags: [Admin]
      summary: Get admin dashboard statistics
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Dashboard statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      users:
                        type: object
                      inventory:
                        type: object
                      sales:
                        type: object
                      approvals:
                        type: object
                        
  /v1/purchases/leads:
    post:
      tags: [Purchases]
      summary: Create a new purchase lead
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [source, contactInfo]
              properties:
                source:
                  type: string
                  enum: [phone, email, walk-in, website, referral, social-media, other]
                contactInfo:
                  type: object
                  required: [name]
                  properties:
                    name:
                      type: string
                    phone:
                      type: string
                    email:
                      type: string
                vehicleInfo:
                  type: object
                  properties:
                    make:
                      type: string
                    model:
                      type: string
                    year:
                      type: integer
                    mileage:
                      type: number
                    askingPrice:
                      type: number
      responses:
        '201':
          description: Lead created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Lead'
    get:
      tags: [Purchases]
      summary: Get all purchase leads
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
        - in: query
          name: search
          schema:
            type: string
      responses:
        '200':
          description: List of leads
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Lead'
                      
  /v1/purchases/po:
    post:
      tags: [Purchases]
      summary: Create Purchase Order
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [vehicleId, amount, investorAllocations]
              properties:
                vehicleId:
                  type: string
                amount:
                  type: number
                investorAllocations:
                  type: array
                  items:
                    type: object
                    required: [investorId, amount, percentage]
                    properties:
                      investorId:
                        type: string
                      amount:
                        type: number
                      percentage:
                        type: number
      responses:
        '201':
          description: PO created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/PurchaseOrder'
                    
  /v1/purchases/po/{id}/approve:
    post:
      tags: [Purchases]
      summary: Admin approve Purchase Order (dual approval)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                comments:
                  type: string
      responses:
        '200':
          description: Approval recorded
        '400':
          description: Already approved by this admin
          
  /v1/purchases/inventory:
    get:
      tags: [Purchases]
      summary: Get inventory
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
        - in: query
          name: make
          schema:
            type: string
      responses:
        '200':
          description: Inventory list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Vehicle'
                      
  /v1/sales/{vehicleId}/close:
    post:
      tags: [Sales]
      summary: Close a sale
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: vehicleId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [customerName, sellingPrice]
              properties:
                customerName:
                  type: string
                customerContact:
                  type: object
                  properties:
                    phone:
                      type: string
                    email:
                      type: string
                sellingPrice:
                  type: number
      responses:
        '201':
          description: Sale created
          
  /v1/sales/{id}/approve:
    post:
      tags: [Sales]
      summary: Admin approve sale (dual approval)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Sale approved
          
  /v1/investors/{id}/soa:
    get:
      tags: [Investors]
      summary: Get investor Statement of Accounts
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: SOA data
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      investor:
                        type: object
                      creditLimit:
                        type: number
                      utilizedAmount:
                        type: number
                      remainingCredit:
                        type: number
                      investments:
                        type: array
                        items:
                          type: object
                          
  /v1/export/inventory:
    get:
      tags: [Exports]
      summary: Export inventory to Excel
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
      responses:
        '200':
          description: Excel file
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
                
  /v1/export/leads:
    get:
      tags: [Exports]
      summary: Export leads to Excel
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: type
          schema:
            type: string
            enum: [purchase, sales]
      responses:
        '200':
          description: Excel file
          
  /integrations/docusign/send-po/{poId}:
    post:
      tags: [Integrations]
      summary: Send PO via DocuSign
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: poId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Envelope sent
          
  /webhooks/docusign:
    post:
      tags: [Webhooks]
      summary: DocuSign webhook callback
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook processed

